name: ä¾èµ–æ›´æ–°æ£€æŸ¥

on:
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨ 3 ç‚¹è¿è¡Œ
    - cron: '0 3 * * 1'
  workflow_dispatch:

jobs:
  check-dependencies:
    name: æ£€æŸ¥ä¾èµ–æ›´æ–°
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
    
    - name: å®‰è£… uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
    
    - name: æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–
      run: |
        uv pip install pip-check
        uv sync
        echo "ğŸ“¦ æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–..."
        uv pip list --outdated || true
    
    - name: ç”Ÿæˆä¾èµ–æŠ¥å‘Š
      run: |
        echo "# ä¾èµ–æŠ¥å‘Š" > dependency-report.md
        echo "" >> dependency-report.md
        echo "## å½“å‰ä¾èµ–" >> dependency-report.md
        uv pip list >> dependency-report.md
        echo "" >> dependency-report.md
        echo "## è¿‡æ—¶ä¾èµ–" >> dependency-report.md
        uv pip list --outdated >> dependency-report.md || echo "æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æœ€æ–°çš„ï¼" >> dependency-report.md
    
    - name: ä¸Šä¼ ä¾èµ–æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: dependency-report
        path: dependency-report.md
        retention-days: 30

  security-audit:
    name: å®‰å…¨å®¡è®¡
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
    
    - name: å®‰è£… uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
    
    - name: å®‰è£…ä¾èµ–
      run: |
        uv sync
    
    - name: å®‰å…¨å®¡è®¡
      run: |
        uv pip install pip-audit
        uv run pip-audit --format json --output audit-report.json
      continue-on-error: true
    
    - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-audit-report
        path: audit-report.json
        retention-days: 30
      continue-on-error: true

