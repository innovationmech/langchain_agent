name: ä»£ç è´¨é‡

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨ 2 ç‚¹è¿è¡Œ
    - cron: '0 2 * * 1'
  workflow_dispatch:

jobs:
  format-check:
    name: ä»£ç æ ¼å¼æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
    
    - name: å®‰è£… uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
    
    - name: å®‰è£…ä¾èµ–
      run: |
        uv sync --extra dev
    
    - name: æ£€æŸ¥ä»£ç æ ¼å¼
      run: |
        uv run black --check --diff src/ tests/ main.py
    
    - name: è‡ªåŠ¨æ ¼å¼åŒ–å»ºè®®
      if: failure()
      run: |
        echo "ðŸ’¡ ä»£ç æ ¼å¼ä¸ç¬¦åˆ Black æ ‡å‡†"
        echo "è¿è¡Œä»¥ä¸‹å‘½ä»¤ä¿®å¤ï¼š"
        echo "  make format"
        echo "  æˆ–"
        echo "  black src/ tests/ main.py"

  lint:
    name: Linting æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
    
    - name: å®‰è£… uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
    
    - name: å®‰è£…ä¾èµ–
      run: |
        uv sync --extra dev
    
    - name: Flake8 æ£€æŸ¥
      run: |
        uv run flake8 src/ tests/ main.py \
          --count \
          --show-source \
          --statistics \
          --max-line-length=100 \
          --extend-ignore=E203,W503
    
    - name: ç”Ÿæˆ Flake8 æŠ¥å‘Š
      if: always()
      run: |
        uv run flake8 src/ tests/ main.py \
          --format=html \
          --htmldir=flake8-report \
          --max-line-length=100 \
          --extend-ignore=E203,W503
      continue-on-error: true
    
    - name: ä¸Šä¼  Flake8 æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: flake8-report
        path: flake8-report/
        retention-days: 7
      continue-on-error: true

  type-check:
    name: ç±»åž‹æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
    
    - name: å®‰è£… uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
    
    - name: å®‰è£…ä¾èµ–
      run: |
        uv sync --extra dev
    
    - name: MyPy ç±»åž‹æ£€æŸ¥
      run: |
        uv run mypy src/ --html-report mypy-report
      continue-on-error: true
    
    - name: ä¸Šä¼  MyPy æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mypy-report
        path: mypy-report/
        retention-days: 7
      continue-on-error: true

  coverage-report:
    name: æµ‹è¯•è¦†ç›–çŽ‡æŠ¥å‘Š
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
    
    - name: å®‰è£… uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
    
    - name: å®‰è£…ä¾èµ–
      run: |
        uv sync --extra dev
    
    - name: ç”Ÿæˆè¦†ç›–çŽ‡æŠ¥å‘Š
      run: |
        uv run pytest --cov=src --cov-report=html --cov-report=term
    
    - name: ä¸Šä¼ è¦†ç›–çŽ‡æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov/
        retention-days: 7
    
    - name: ç”Ÿæˆè¦†ç›–çŽ‡å¾½ç« æ•°æ®
      run: |
        COVERAGE=$(uv run pytest --cov=src --cov-report=term | grep TOTAL | awk '{print $4}' | sed 's/%//')
        echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV
        echo "ðŸ“Š æµ‹è¯•è¦†ç›–çŽ‡: $COVERAGE%"

